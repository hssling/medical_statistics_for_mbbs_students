name: Deploy Medical Statistics Website

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js ğŸ”§
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Python ğŸ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python dependencies ğŸ“¦
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Install Node.js dependencies ğŸ“¦
      run: |
        npm install

    - name: Lint JavaScript code ğŸ”
      run: |
        if command -v npx &> /dev/null; then
          npx eslint website/assets/js/*.js --max-warnings 0 || true
        fi

    - name: Check HTML validity ğŸ¯
      run: |
        npm install html-validator-cli -g
        if [ -n "$(find website -name "*.html" | head -1)" ]; then
          html-validator website/index.html --quiet || true
        fi

    - name: Check file sizes ğŸ“Š
      run: |
        echo "File sizes:"
        find website -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" \) -exec ls -lh {} \; | head -10

    - name: Test local server startup ğŸ§ª
      run: |
        timeout 10s python -m http.server 8000 --directory website > /tmp/server.log 2>&1 &
        sleep 3
        if curl -s http://localhost:8000/ > /dev/null; then
          echo "âœ… Local server starts successfully"
        else
          echo "âŒ Local server failed to start"
          cat /tmp/server.log
          exit 1
        fi

    - name: Deploy to GitHub Pages ğŸš€
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: JamesIves/github-pages-deploy-action@v4.4.1
      with:
        folder: website
        single-commit: true
        clean: true
        clean-exclude: |
          .git
          .github

    - name: Update deployment status ğŸ“
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "ğŸŒ Website deployed successfully!"
        echo "ğŸ“ Live URL: https://hssling.github.io/medical_statistics_for_mbbs_students/"
        echo "ğŸ•’ Deployed at: $(date)"
